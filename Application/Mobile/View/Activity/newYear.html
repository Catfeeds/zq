<extend name="Public/base" />
<block name="seo">
    <title>制作球星祝福</title>
</block>
<block name="append">

    <!-- 本页需要引用的css -->
    <link rel="stylesheet" href="__CSS__/activity/newYear/star.css">
    <link rel="stylesheet" href="__CSS__/activity/newYear/swiper.css">

</block>
<block name="body"><body>
<div class="logo_link"><a href="{:U('/')}"></a></div>
<div id="app-bar" class="app-bar ios_touch" style="display:none">
    <!-- <div class="app-logo"><img src="__IMAGES__/app-logo.png"></div> -->
    <a class="app-close ios_touch" id="cone" href="javascript:;"></a>
    <!-- <a class="app-btn" href="{:U('/App/introduce')}" target='_blank'>立即下载</a> -->
    <a href="//m.qqty.com/H5/appJump/sign/shmt.html" class="down_year"></a>
</div>
</block>
<block name="header">
</block>
<block name="nav">
</block>
<block name="content">
    <div id="content" style="height: {$imgHeight}%;">
        <!-- <div class="logo"><img src="__IMAGES__/activity/newYear/logo.png" alt="logo"></div> -->
        <header class="star_header">
            <div class="head_body body_mc">
                <div class="s_word">
                    <p><span style="font-family: 微软雅黑" id="to_demo">To: All friends</span><span id="to_name"></span></p>
                    <p style="padding-top: .1rem;text-align: center;"><em id="word_con" class="font_qqty">金鸡贺岁,大吉大利</em></p>
                    <p style="text-align: right;padding-right: .2rem"><span id="qianming" class="font_qqty">C罗</span></p>
                </div>
            </div>
        </header>


        <section class="s_content">
            <div class="top_bt_bg"></div>

            <section class="star_bg" id="star_bg">
                <!-- Swiper -->
                <div class="swiper-container">
                    <div class="swiper-wrapper">
                        <figure class="swiper-slide star_head">
                            <ul>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/cluo.png" title="金鸡贺岁，大吉大利" alt="cluo" class="on">
                                    <figcaption>C罗</figcaption>
                                </li>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/mx.png" title="鸡祥如意，新年行大运" alt="mx">
                                    <figcaption>梅西</figcaption>
                                </li>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/kst.png" title="颜值比鸡高" alt="kst">
                                    <figcaption>科斯塔</figcaption>
                                </li>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/cjk.png" title="鸡年逢赌必赢" alt="cjk">
                                    <figcaption>苍井空</figcaption>
                                </li>
                            </ul>
                        </figure>
                        <figure class="swiper-slide star_head">
                            <ul>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/nme.png" title="梦想起航 赢战2017" alt="nme">
                                    <figcaption>内马尔</figcaption>
                                </li>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/ml.png" title="鸡年吉祥！咯咯哒" alt="ml">
                                    <figcaption>穆勒</figcaption>
                                </li>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/jl.png" title="鸡年大吉吧" alt="jl">
                                    <figcaption>吉鲁</figcaption>
                                </li>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/bdyjy.png" title="鸡年逢胸化吉" alt="bdyjy">
                                    <figcaption>波多野结衣</figcaption>
                                </li>
                                
                            </ul>
                        </figure>
                        <figure class="swiper-slide star_head">
                            <ul>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/yb.png" title="鸡年纵横球场" alt="yb">
                                    <figcaption>伊布</figcaption>
                                </li>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/kdna.png" title="鸡年“红”运当头" alt="kdna">
                                    <figcaption>库蒂尼奥</figcaption>
                                </li>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/lms.png" title="弄好发型，准备绝杀" alt="lms">
                                    <figcaption>拉莫斯</figcaption>
                                </li>
                                <li>
                                    <img src="__IMAGES__/activity/newYear/head/lzll.png" title="鸡年越来越猛" alt="lzll">
                                    <figcaption>泷泽萝拉</figcaption>
                                </li>
                            </ul>
                        </figure>
                    </div>
                    <!-- Add Pagination -->
                    <div class="swiper-pagination"></div>
                </div>
            </section>

            <footer class="s_footer" id="add_ca">
                <div class="yname y_com"><span>你的名字：</span><input type="text" placeholder="输入你要祝福的人" id="yname"></div>
                <div class="yzhufu y_com"><span>祝福语：</span><input id="yzhufu" type="text" placeholder="金鸡贺岁,大吉大利"></div>
                <div class="sub_btn"><img src="__IMAGES__/activity/newYear/submit.png" alt="生成贺卡"></div>
            </footer>
               
            <footer class="s_footer" style="min-height: 100%;display: none;" id="sub_end">
                <div class="newyear">
                    <img src="__IMAGES__/activity/newYear/newyear.png" alt="新年快乐">
                </div>
                <div class="ewm">
                    <img src="__IMAGES__/activity/newYear/ewm.png" alt="二维码">
                </div>
                <div class="saoma"><img src="__IMAGES__/activity/newYear/saoma.png" alt="扫码领祝福"></div>

            </footer>
        </section>

    </div>
    <input type="hidden" id="imgUrl" />
    <!--<div id="contentImg" ></div>-->
    <!--<div id="contentImg" ><img src="" /></div>-->
    <!-- 分享提示 s-->
    <div id="maskLayer" style="opacity: .6;"></div>
    <!--<div id="share_tip"><img src="__IMAGES__/activity/newYear/share_tip.png" alt=""></div>-->
    <div id="share_con" class="modal">
        <div style="height: .4rem;  line-height: .4rem; text-align: center; font-size: .3rem;">长按图片保存到手机↓</div>
        <div class="modal-body">
            <img id="createImg" id="js-img" src="__IMAGES__/default.jpg" alt="海报">
        </div>
        <a class="close" href="javascript:void(0)"></a>
    </div>
    <div class="star_loading" id="star_loading"></div>
    <div class="shengc_tip">正在生成,请等待几秒...</div>
</block>
<block name="footer"></block>
<block name="scripts">
    <!-- Swiper JS -->
    <script src="__JS__/activity/newYear/swiper.js"></script>
    <script type="text/javascript" src="__PUBLIC__/Mobile/Plugs/html2canvas.js"></script>
    <script type="text/javascript" src="__PUBLIC__/Mobile/Plugs/canvas2image.js"></script>
    <!--<script type="text/javascript" src="__PUBLIC__/Mobile/Plugs/lrz.all.bundle.js"></script>-->
    <script>
        var IMAGES = '__IMAGES__';
    </script>
    <script>
        /**
         * 将以base64的图片url数据转换为Blob
         * @param urlData
         *            用url方式表示的base64图片数据
         */
        function convertBase64UrlToBlob(urlData){

            var bytes=window.atob(urlData.split(',')[1]);        //去掉url的头，并转换为byte

            //处理异常,将ascii码小于0的转换为大于0
            var ab = new ArrayBuffer(bytes.length);
            var ia = new Uint8Array(ab);
            for (var i = 0; i < bytes.length; i++) {
                ia[i] = bytes.charCodeAt(i);
            }

            return new Blob( [ab] , {type : 'image/png'});
        }

        function base64Img2Blob(code){
            var parts = code.split(';base64,');
            var contentType = parts[0].split(':')[1];
            var raw = window.atob(parts[1]);
            var rawLength = raw.length;

            var uInt8Array = new Uint8Array(rawLength);

            for (var i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], {type: contentType});
        }
        function downloadFile(fileName, content){

            var aLink = document.createElement('a');
            var blob = base64Img2Blob(content); //new Blob([content]);

            var evt = document.createEvent("HTMLEvents");
            evt.initEvent("click", false, false);//initEvent 不加后两个参数在FF下会报错
            aLink.download = fileName;
            aLink.href = URL.createObjectURL(blob);

            $('#createImg').attr('src',URL.createObjectURL(blob));
            aLink.dispatchEvent(evt);
        }

        function createPngImage() {
            var htmlToImage = $('#content');

            var width = htmlToImage.width();

            var height = htmlToImage.height();

            var type = "png";

            var scaleBy = 1.3;

            var canvas = document.createElement('canvas');

            canvas.width = width * scaleBy;

            canvas.height = height * scaleBy + 35;

            canvas.style.width = width * scaleBy + 'px';

            canvas.style.height = height * scaleBy + 'px';

            var context = canvas.getContext('2d');

            context.scale(scaleBy, scaleBy);

            context.font = 'Microsoft YaHei';

            html2canvas(htmlToImage, {

                canvas: canvas,
                width:width * scaleBy,
                height:height * scaleBy,

                onrendered: function (canvas) {

                    var dataUrl = canvas.toDataURL('image/png');

                    $.ajax({
                        type:'POST',
                        dataType:'json',
                        url:'/Activity/newYear.html',
                        data:{baseImg:dataUrl},
                        success:function (data) {
                            $('#createImg').attr('src',data.imgUrl);
                            $('#imgUrl').val(data.imgName);
                        },
                        complete:function () {
                            setTimeout(function () {
                                $('#star_loading').hide();
                                $('.shengc_tip').hide();
                            }, 500);

                        }
                    });

                }

            });


        }
        $(function(){

//            lrz(this.files[0])
//                    .then(function (rst) {
//                        // 处理成功会执行
//                    })
//                    .catch(function (err) {
//                        // 处理失败会执行
//                    })
//                    .always(function () {
//                        // 不管是成功失败，都会执行
//                    });

            $('#app-bar').append('<div class="btn_down"></div>');

            checkWord();
            //头像点击
            $('.star_head ul li').on('click',function(){

                $('#yzhufu').val('');

                var img_alt = $(this).children('img').attr('alt');
                var img_title = $(this).children('img').attr('title');
                var star_name = $(this).children('img').next('figcaption').html();
                $('#qianming').html(star_name);
                $('#yzhufu').attr('placeholder',img_title)
                // $('.star_head ul li').children('img').removeClass('on');
                // $(this).children('img').addClass('on');

                $('.head_body').attr('class','head_body body_' + img_alt);
                $('#word_con').html(img_title);

                checkWord();

                //设置牌匾高度
                if(img_alt == "cjk" || img_alt == "lzll" || img_alt == "bdyjy"){
                    $('.s_word').css('margin-top','4.8rem');
                }else{
                    $('.s_word').css('margin-top','4.2rem');
                }
              
            });
            //生成贺卡
            $('.sub_btn').on('click',function(){
                
                String.prototype.len = function()           
                { 
                    return this.replace(/[^\x00-\xff]/g, "xx").length; 
                } 
                if ($('#yname').val().len() > 16)
                {
                    alert('名字长度不能大于8！');
                    return;
                }
                if ($('#yzhufu').val().len() > 20)
                {
                    alert('祝福语长度不能大于10！');
                    return;
                }
                
                $('#createImg').attr('src','__PUBLIC__/Mobile/images/default.jpg');

                 $('#star_bg').hide();
                 $('#add_ca').hide();
                 $('#sub_end').show();
                 $('#star_loading').show();
                 $('.shengc_tip').show();

                createPngImage();
                //显示分享提示
                $('#maskLayer').show();
                $('#share_con').show();


            });
            //关闭
            $('.close').on('click',function(){
                $('#maskLayer').hide();
                $('#share_con').hide();

                $.ajax({
                    type:'POST',
                    dataType:'json',
                    url:'/Activity/removeNewYear.html',
                    data:{imgUrl:$('#imgUrl').val()},
                    success:function (data) {
                        console.log(data.msg)
                    }
                });
                $('#star_bg').show();
                $('#add_ca').show();
                $('#sub_end').hide();
            })
            //分享点击
            $('#share_tip').on('click',function(){
                $('#maskLayer').hide();
                $('#share_tip').hide();

//                createPngImage();

            });


            //名字键盘响应
            $('#yname').on('blur',function(){
                $('#to_demo').html('To:');
                $('#to_name').html($(this).val());
                if($(this).val()==""){
                    //$('#to_name').html('');
                    $('#to_demo').html('To: All friends');
                }
            })
            //祝福语键盘响应
            $('#yzhufu').on('blur',function(){
                $('#word_con').html($(this).val());
                checkWord();
                if($(this).val()==""){
                    $('#word_con').html('新年行大运');
                }
//                if($(this).val().length > 10){
//                    alert('为了美观，建议输入最多10个字符')
//                }
            });


            //判断字体长度，设定字体大小
            function checkWord(){
                var w_len = $('#word_con').html().length;
                if(w_len >= 7 && w_len <= 9){
                    $('#word_con').css('font-size','.54rem');
                }else if(w_len > 9){
                    $('#word_con').css('font-size','.48rem');
                }else{
                    $('#word_con').css('font-size','.54rem');
                }
            }
        })
        //banner 切换
        var swiper = new Swiper('.swiper-container', {
            pagination: '.swiper-pagination',
            slidesPerView: 1,
            paginationClickable: true,
            spaceBetween: 30
        });
        setInterval(function(){
          $('.btn_down').addClass('on');
        },1500);
        setInterval(function(){
          $('.btn_down').removeClass('on');
        },3000)
    </script>
    <script type="text/javascript" src="//res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script>
        var title='球星女神来给你送鸡年祝福 | 你选谁？';
        var img='__PUBLIC__/Mobile/images/activity/newYear/share.jpg';
        var desc='祝你鸡年大吉吧__全球体育APP';
        wx.config({
            debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。

            appId: "{$appid}", // 必填，公众号的唯一标识

            timestamp: "{$time}", // 必填，生成签名的时间戳

            nonceStr: "{$nonceStr}", // 必填，生成签名的随机串

            signature: "{$signature}", // 必填，签名，见附录1

            jsApiList: ['onMenuShareTimeline','onMenuShareAppMessage','onMenuShareQQ','onMenuShareQZone','onMenuShareQZone','onMenuShareWeibo'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2

        });
        wx.ready(function () {
            wx.onMenuShareTimeline({
                title: title, // 分享标题

                link: "{$link}", // 分享链接

                imgUrl: img, // 分享图标

                success: function () {

                    // 用户确认分享后执行的回调函数

                },
                cancel: function () {

                    // 用户取消分享后执行的回调函数

                }

            });
            wx.onMenuShareWeibo({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link: "{$link}", // 分享链接
                imgUrl: img, // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });
            wx.onMenuShareAppMessage({
                title: title, // 分享标题

                desc: desc, // 分享描述

                link: "{$link}", // 分享链接

                imgUrl: img, // 分享图标

                type: '', // 分享类型,music、video或link，不填默认为link

                dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空

                success: function () {

                    // 用户确认分享后执行的回调函数

                },
                cancel: function () {

                    // 用户取消分享后执行的回调函数

                }
            });
            wx.onMenuShareQQ({
                title: title, // 分享标题

                desc: desc, // 分享描述

                link: "{$link}", // 分享链接

                imgUrl: img, // 分享图标

                success: function () {

                    // 用户确认分享后执行的回调函数

                },
                cancel: function () {

                    // 用户取消分享后执行的回调函数

                }

            });
            wx.onMenuShareQZone({
                title: title, // 分享标题

                desc: desc, // 分享描述

                link: "{$link}", // 分享链接

                imgUrl: img, // 分享图标

                success: function () {

                    // 用户确认分享后执行的回调函数

                },
                cancel: function () {

                    // 用户取消分享后执行的回调函数

                }

            });
        });

    </script>
</block>
<block name="download">

</block>